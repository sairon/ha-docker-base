name: Build base images

on:
  pull_request:
    branches: ["master"]
  release:
    types: ["published"]
  workflow_dispatch:
    inputs: {}

env:
  IMAGE_REPO: ghcr.io/${{ github.repository_owner }}
  ARCHITECTURES: '["amd64", "aarch64"]'
  ALPINE_LATEST: "3.23"
  DEBIAN_LATEST: "trixie"
  UBUNTU_LATEST: "24.04"
  PYTHON_LATEST: "3.14"

jobs:
  init:
    name: Initialize build
    runs-on: ubuntu-latest
    outputs:
      architectures: ${{ steps.meta.outputs.architectures }}
      version: ${{ steps.meta.outputs.version }}
      alpine_latest: ${{ steps.meta.outputs.alpine_latest }}
      debian_latest: ${{ steps.meta.outputs.debian_latest }}
      ubuntu_latest: ${{ steps.meta.outputs.ubuntu_latest }}
      python_latest: ${{ steps.meta.outputs.python_latest }}
      image_repo: ${{ steps.meta.outputs.image_repo }}
    steps:
      - name: Set build metadata
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            version="${{ github.event.release.tag_name }}"
          else
            version="${GITHUB_SHA::7}"
          fi

          echo "architectures=${{ env.ARCHITECTURES }}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "alpine_latest=${{ env.ALPINE_LATEST }}" >> "$GITHUB_OUTPUT"
          echo "debian_latest=${{ env.DEBIAN_LATEST }}" >> "$GITHUB_OUTPUT"
          echo "ubuntu_latest=${{ env.UBUNTU_LATEST }}" >> "$GITHUB_OUTPUT"
          echo "python_latest=${{ env.PYTHON_LATEST }}" >> "$GITHUB_OUTPUT"
          echo "image_repo=${{ env.IMAGE_REPO }}" >> "$GITHUB_OUTPUT"

  build_alpine:
    name: Alpine ${{ matrix.alpine_version }}
    needs: init
    strategy:
      fail-fast: false
      matrix:
        alpine_version: ["3.21", "3.22", "3.23"]
    uses: ./.github/workflows/reuseable-builder.yml
    with:
      image_repo: ${{ needs.init.outputs.image_repo }}
      image_name: base
      image_tag: ${{ matrix.alpine_version }}
      tag_latest: ${{ matrix.alpine_version == needs.init.outputs.alpine_latest }}
      context: alpine
      architectures: ${{ needs.init.outputs.architectures }}
      version: ${{ needs.init.outputs.version }}
      build_args: |
        ALPINE_VERSION=${{ matrix.alpine_version }}

  build_debian:
    name: Debian ${{ matrix.debian_version }}
    needs: init
    strategy:
      fail-fast: false
      matrix:
        debian_version: ["bookworm", "trixie"]
    uses: ./.github/workflows/reuseable-builder.yml
    with:
      image_repo: ${{ needs.init.outputs.image_repo }}
      image_name: debian
      image_tag: ${{ matrix.debian_version }}
      tag_latest: ${{ matrix.debian_version == needs.init.outputs.debian_latest }}
      context: debian
      architectures: ${{ needs.init.outputs.architectures }}
      version: ${{ needs.init.outputs.version }}
      build_args: |
        DEBIAN_VERSION=${{ matrix.debian_version }}

  build_ubuntu:
    name: Ubuntu ${{ matrix.ubuntu_version }}
    needs: init
    strategy:
      fail-fast: false
      matrix:
        ubuntu_version: ["22.04", "24.04"]
    uses: ./.github/workflows/reuseable-builder.yml
    with:
      image_repo: ${{ needs.init.outputs.image_repo }}
      image_name: ubuntu
      image_tag: ${{ matrix.ubuntu_version }}
      tag_latest: ${{ matrix.ubuntu_version == needs.init.outputs.ubuntu_latest }}
      context: ubuntu
      architectures: ${{ needs.init.outputs.architectures }}
      version: ${{ needs.init.outputs.version }}
      build_args: |
        UBUNTU_VERSION=${{ matrix.ubuntu_version }}

  build_python:
    name: Alpine ${{ matrix.alpine_version }} - Python ${{ matrix.python_version }}
    needs: [init, build_alpine]
    strategy:
      fail-fast: false
      matrix:
        alpine_version: ["3.21", "3.22", "3.23"]
        python_version: ["3.12", "3.13", "3.14"]
    uses: ./.github/workflows/reuseable-builder.yml
    with:
      image_repo: ${{ needs.init.outputs.image_repo }}
      image_name: base-python
      image_tag: ${{ matrix.python_version }}-alpine${{ matrix.alpine_version }}
      tag_latest: ${{ matrix.alpine_version == needs.init.outputs.alpine_latest && matrix.python_version == needs.init.outputs.python_latest }}
      context: python/${{ matrix.python_version }}
      architectures: ${{ needs.init.outputs.architectures }}
      version: ${{ needs.init.outputs.version }}
      build_args: |
        BASE_IMAGE=ghcr.io/${{ github.repository_owner }}/base
        BASE_VERSION=${{ matrix.alpine_version }}
        PYTHON_VERSION=${{ matrix.python_version }}
